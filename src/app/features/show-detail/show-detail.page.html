<app-loader [show]="loading()"></app-loader>
<section *ngIf="show() as s">
  <div style="display:flex; gap:16px; align-items:flex-start; flex-wrap: wrap;">
    <img [ngSrc]="s.image?.original || s.image?.medium || 'https://placehold.co/600x800'" width="300" height="450" alt="{{s.name}}" style="border-radius:8px; object-fit:cover;" priority>
    <div style="flex:1; min-width:260px;">
      <h1 style="margin-top:0;">{{s.name}}</h1>
      <div class="muted">{{s.genres?.join(', ')}}</div>
      <div class="muted">Language: {{s.language}} | Premiered: {{s.premiered}} | Network: {{s.network?.name}}</div>
      <div class="muted">Rating: {{s.rating?.average || 'N/A'}}</div>
      
      <!-- User Reviews Summary -->
      @if (showReviews().length > 0) {
        <div class="reviews-summary">
          <h3>User Reviews</h3>
          <div class="rating-summary">
            <span class="average-rating">⭐ {{averageRating()}}</span>
            <span class="review-count">({{showReviews().length}} review{{showReviews().length !== 1 ? 's' : ''}})</span>
          </div>
          <a routerLink="/reviews" class="add-review-link">Add your review</a>
        </div>
      }
      @if (showReviews().length === 0) {
        <div class="no-reviews">
          <p>No user reviews yet.</p>
          <a routerLink="/reviews" class="add-review-link">Be the first to review!</a>
        </div>
      }
      
      <hr>
      <div [innerHTML]="s.summary"></div>
      <div> {{s.summary}}</div>
    </div>
  </div>

  <!-- User Reviews Section -->
  @if (showReviews().length > 0) {
    <section>
      <h2>User Reviews</h2>
      <div class="reviews-grid">
        @for (review of showReviews(); track review.id) {
          <div class="review-card">
            <div class="review-header">
              <span class="review-rating">⭐ {{review.rating}}</span>
              <span class="review-date">{{review.createdAt | date:'short'}}</span>
            </div>
            <p class="review-comment">{{review.comment}}</p>
          </div>
        }
      </div>
    </section>
  }

  <h2>Cast</h2>
  <div class="grid">
    @for (c of cast(); track c.person.id) {
      <div class="card">
        <img [src]="c.person.image?.medium || c.person.image?.original || 'https://placehold.co/400x400'" alt="{{c.person.name}}" priority>
        <div class="content">
          <strong>{{c.person.name}}</strong>
          <div class="muted">as {{c.character.name}}</div>
        </div>
      </div>
    }
  </div>

  <h2>Episodes</h2>
  <div>
    @for (season of seasons(); track season[0]) {
      <details>
        <summary style="cursor:pointer; padding:8px 0; font-weight:600;">Season {{season[0]}}</summary>
        <div class="grid">
          @for (e of season[1]; track e.id) {
            <div class="card">
              <div class="content">
                <div style="display:flex; justify-content:space-between; align-items:center; gap:8px;">
                  <strong>S{{e.season}}E{{e.number}} — {{e.name}}</strong>
                  <button (click)="openTrailer(e)">Trailer</button>
                </div>
                <div class="muted">Air date: {{e.airdate || 'N/A'}}</div>
                <div [innerHTML]="e.summary"></div>
              </div>
            </div>
          }
        </div>
      </details>
    }
  </div>
</section>
